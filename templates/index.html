{% extends "layout.html" %}

{% block content %}
<div class="center-panel">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <div class="banner-content">
            <div>
                <h1 style="margin:0;font-size:28px;color:var(--text)">Welcome back, {{ current_user.username|display_name or 'Guest' }}!</h1>
                <p style="margin:8px 0 0 0;color:var(--muted);font-size:15px">Explore the latest insights from our community</p>
            </div>
            <div style="text-align:right;display:flex;gap:12px;align-items:center">
                <!-- Feed Toggle -->
                <div style="display:flex;gap:6px;background:rgba(0,212,255,0.08);border-radius:10px;padding:6px">
                    <a href="{{ url_for('index', feed='for_you') }}" class="feed-tab {% if feed_type == 'for_you' or not feed_type %}active{% endif %}" style="padding:8px 16px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;cursor:pointer;transition:0.2s;{% if feed_type == 'for_you' or not feed_type %}background:var(--primary);color:white{% endif %}">
                        <i class="fas fa-fire"></i> For You
                    </a>
                    <a href="{{ url_for('index', feed='following') }}" class="feed-tab {% if feed_type == 'following' %}active{% endif %}" style="padding:8px 16px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;cursor:pointer;transition:0.2s;{% if feed_type == 'following' %}background:var(--primary);color:white{% endif %}">
                        <i class="fas fa-heart"></i> Following
                    </a>
                </div>
                <a href="{{ url_for('create_post') }}" class="btn-primary" style="width:auto;padding:12px 24px;font-size:16px">
                    <i class="fas fa-plus"></i> New Post
                </a>
            </div>
        </div>
    </div>

    <div style="height:30px"></div>

    <!-- Main Content Grid -->
    <div class="blog-grid">
        <!-- Sidebar -->
        <aside class="blog-sidebar">
            <!-- Profile Card -->
            <div class="sidebar-card">
                <h3 style="margin-top:0;color:var(--text);font-size:16px">Your Profile</h3>
                <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
                    <img src="{{ avatar_url(current_user,56) }}" style="width:56px;height:56px;border-radius:10px;object-fit:cover;border:2px solid rgba(0,212,255,0.2)">
                    <div>
                        <div style="font-weight:700;color:var(--text)">{{ current_user.username|display_name or 'Guest' }}</div>
                        <div style="color:var(--muted);font-size:12px">Member since {{ current_user.created_at.strftime('%b %Y') if current_user.is_authenticated and current_user.created_at else '' }}</div>
                        <div style="margin-top:6px;display:flex;gap:12px;font-size:11px;font-weight:600;color:var(--primary)">
                            <a href="{{ url_for('view_followers') }}" style="text-decoration:none;color:var(--primary);cursor:pointer;transition:0.2s" onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">
                                <i class="fas fa-user-friends"></i> {{ current_user.followers.count() }} Followers
                            </a>
                            <a href="{{ url_for('view_following') }}" style="text-decoration:none;color:var(--accent-warm);cursor:pointer;transition:0.2s" onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">
                                <i class="fas fa-heart"></i> {{ current_user.following_users.count() }} Following
                            </a>
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('my_account') }}" style="display:block;padding:10px;border-radius:8px;background:rgba(0,212,255,0.1);color:var(--primary);text-decoration:none;text-align:center;font-weight:600;transition:0.2s">
                    Manage Profile
                </a>
            </div>

            <!-- Navigation Card -->
            <div class="sidebar-card">
                <h3 style="margin-top:0;color:var(--text);font-size:16px">Navigation</h3>
                <nav style="display:flex;flex-direction:column;gap:8px">
                    <a href="{{ url_for('index') }}" style="padding:10px 12px;border-radius:8px;color:var(--text);text-decoration:none;background:rgba(0,212,255,0.05);border-left:3px solid var(--primary);transition:0.2s">
                        <i class="fas fa-home"></i> Home Feed
                    </a>
                    <a href="{{ url_for('create_post') }}" style="padding:10px 12px;border-radius:8px;color:var(--text);text-decoration:none;transition:0.2s;display:flex;align-items:center;gap:8px">
                        <i class="fas fa-pen-fancy"></i> Write Article
                    </a>
                    <a href="{{ url_for('my_account') }}" style="padding:10px 12px;border-radius:8px;color:var(--text);text-decoration:none;transition:0.2s;display:flex;align-items:center;gap:8px">
                        <i class="fas fa-file-lines"></i> My Posts
                    </a>
                </nav>
            </div>

            <!-- Stats Card -->
            <div class="sidebar-card">
                <h3 style="margin-top:0;color:var(--text);font-size:16px">Community Stats</h3>
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="padding:12px;background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(0,212,255,0.02));border-radius:8px;border-left:3px solid var(--primary)">
                        <div style="font-size:12px;color:var(--muted)">Total Posts</div>
                        <div style="font-size:20px;font-weight:700;color:var(--text)">{{ posts.total if posts else 0 }}</div>
                    </div>
                    <div style="padding:12px;background:linear-gradient(135deg,rgba(255,107,53,0.08),rgba(255,107,53,0.02));border-radius:8px;border-left:3px solid var(--accent-warm)">
                        <div style="font-size:12px;color:var(--muted)">Your Posts</div>
                        <div style="font-size:18px;font-weight:700;color:var(--accent-warm)">{{ current_user.posts|length if current_user.is_authenticated else 0 }}</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Feed -->
        <main class="blog-main">
            <!-- Posts Feed -->
            <div class="posts-section">
                <h2 style="color:var(--text);margin:0 0 20px 0">Latest Articles</h2>
                
                {% if posts and posts.items %}
                    {% for post in posts.items %}
                        <article class="blog-post">
                            <div class="post-header">
                                <div style="display:flex;gap:12px;align-items:center">
                                    <img src="{{ avatar_url(post.author,40) }}" style="width:40px;height:40px;border-radius:8px;object-fit:cover" alt="avatar">
                                    <div>
                                        <div style="font-weight:700;color:var(--text)">{{ post.author.username|display_name }}</div>
                                        <div style="color:var(--muted);font-size:12px">{{ post.published_at.strftime('%b %d, %Y') if post.published_at else '' }}</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:8px;align-items:center">
                                    {% if current_user.is_authenticated and post.author.id != current_user.id %}
                                        <button class="btn-follow" onclick="toggleFollow(this, {{ post.author.id }})">
                                            <i class="fas fa-user-plus"></i>
                                            <span>Follow</span>
                                        </button>
                                    {% endif %}
                                    {% if current_user.is_authenticated and post.user_id == current_user.id %}
                                        <a href="{{ url_for('edit_post', post_id=post.id) }}" style="padding:6px 10px;background:rgba(0,212,255,0.1);color:var(--primary);border:none;border-radius:6px;cursor:pointer;font-size:12px;text-decoration:none">Edit</a>
                                        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('Delete this post?');" style="margin:0">
                                            <button type="submit" style="padding:6px 10px;background:rgba(255,107,107,0.1);color:#ff6b6b;border:none;border-radius:6px;cursor:pointer;font-size:12px">Delete</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>

                            <h3 style="margin:16px 0 10px 0;color:var(--text);font-size:20px;line-height:1.4">{{ post.title }}</h3>
                            
                            <!-- Post Metadata -->
                            <div class="post-meta">
                                <div class="meta-item">
                                    <i class="fas fa-clock meta-icon"></i>
                                    <span>{{ (post.content|length / 200)|int }} min read</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-eye meta-icon"></i>
                                    <span>{{ post.views|default(0) }} views</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-comment meta-icon"></i>
                                    <span>{{ post.comments|length }} comments</span>
                                </div>
                            </div>
                            
                            {% if post.image_filename or post.image_data %}
                                <div class="post-image">
                                    {% if post.image_filename %}
                                        <img src="{{ url_for('static', filename='uploads/' ~ post.image_filename) }}" alt="post image">
                                    {% elif post.image_data %}
                                        <img src="data:image/*;base64,{{ post.image_data }}" alt="post image">
                                    {% endif %}
                                </div>
                            {% endif %}

                            <div class="post-content">{{ post.content|md }}</div>

                            {% if post.tags %}
                                <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:8px">
                                    {% for t in post.tags.split(',') %}
                                        <a href="{{ url_for('posts_by_tag', tag=t.strip()) }}" class="tag-badge">{{ t.strip() }}</a>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <!-- Post Actions -->
                            <div class="post-actions">
                                <button class="btn-like" data-post-id="{{ post.id }}" onclick="toggleLike(this, {{ post.id }})">
                                    <i class="fas fa-heart"></i>
                                    <span>Like</span>
                                    <span style="font-size:11px;opacity:0.8" class="like-count">({{ post.likes|length }})</span>
                                </button>
                                <button class="post-action-btn" onclick="copyPostLink('{{ url_for('index') }}#post-{{ post.id }}')">
                                    <i class="fas fa-share-alt"></i>
                                    Share
                                </button>
                                {% if current_user.is_authenticated and post.user_id == current_user.id %}
                                    <a href="{{ url_for('edit_post', post_id=post.id) }}" class="post-action-btn">
                                        <i class="fas fa-edit"></i>
                                        Edit
                                    </a>
                                    <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('Delete this post?');" style="margin:0;display:inline">
                                        <button type="submit" class="post-action-btn delete">
                                            <i class="fas fa-trash"></i>
                                            Delete
                                        </button>
                                    </form>
                                {% endif %}
                            </div>

                            <!-- Comments Section -->
                            <div class="comments-section">
                                {% if post.comments %}
                                    <div class="comments-header">
                                        <div class="comment-count-badge">{{ post.comments|length }}</div>
                                        <div style="font-weight:700;color:var(--text);font-size:14px">Comments ({{ post.comments|length }})</div>
                                    </div>
                                    <div style="display:flex;flex-direction:column;gap:12px">
                                        {% for comment in post.comments %}
                                            <div class="comment-item">
                                                <div style="display:flex;gap:10px">
                                                    <div class="comment-author-badge">
                                                        <img src="{{ avatar_url(comment.author,32) }}" style="width:32px;height:32px;border-radius:6px;object-fit:cover" alt="avatar">
                                                        {% if comment.author.id == post.author.id %}
                                                            <span class="author-badge">OP</span>
                                                        {% endif %}
                                                    </div>
                                                    <div style="flex:1">
                                                        <div style="display:flex;gap:8px;align-items:center">
                                                            <span style="font-weight:600;font-size:13px;color:var(--text)">{{ comment.author.username|display_name }}</span>
                                                            <span style="font-size:12px;color:var(--muted)">{{ comment.created_at.strftime('%b %d, %Y %H:%M') }}</span>
                                                        </div>
                                                        <div style="color:var(--text);font-size:13px;margin-top:4px;line-height:1.5">{{ comment.body }}</div>
                                                    </div>
                                                    {% if current_user.is_authenticated and (comment.user_id == current_user.id or post.user_id == current_user.id) %}
                                                        <form method="post" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="margin:0">
                                                            <button type="submit" class="post-action-btn delete" style="padding:6px 10px">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                {% if current_user.is_authenticated %}
                                    <form method="post" action="{{ url_for('create_comment', post_id=post.id) }}" class="comment-form">
                                        <input name="body" placeholder="Add a comment..." />
                                        <button type="submit">Post</button>
                                    </form>
                                {% else %}
                                    <div style="padding:14px;background:rgba(0,212,255,0.05);border-radius:8px;text-align:center;color:var(--muted);font-size:13px">
                                        <a href="{{ url_for('login') }}" style="color:var(--primary);text-decoration:none;font-weight:600">Sign in</a> to comment
                                    </div>
                                {% endif %}
                            </div>
                        </article>
                    {% endfor %}
                {% else %}
                    <div style="padding:40px;text-align:center;color:var(--muted)">
                        <i class="fas fa-feather" style="font-size:48px;opacity:0.3;display:block;margin-bottom:12px"></i>
                        <p>No articles yet. <a href="{{ url_for('create_post') }}" style="color:var(--primary);text-decoration:none">Be the first to share!</a></p>
                    </div>
                {% endif %}
            </div>
        </main>
    </div>
    {% if posts and posts.pages and posts.pages > 1 %}
        <div style="display:flex;gap:8px;justify-content:center;margin-top:18px">
            {% if posts.has_prev %}
                {% if pagination_endpoint == 'index' %}
                    <a href="{{ url_for('index', page=posts.prev_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Prev</a>
                {% elif pagination_endpoint == 'search' %}
                    <a href="{{ url_for('search', q=pagination_args['q'], page=posts.prev_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Prev</a>
                {% elif pagination_endpoint == 'posts_by_tag' %}
                    <a href="{{ url_for('posts_by_tag', tag=pagination_args['tag'], page=posts.prev_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Prev</a>
                {% endif %}
            {% endif %}

            {% for p in range(1, posts.pages + 1) %}
                {% if p == posts.page %}
                    <span style="padding:8px 10px;border-radius:8px;background:var(--primary);color:#fff;font-weight:600">{{ p }}</span>
                {% else %}
                    {% if pagination_endpoint == 'index' %}
                        <a href="{{ url_for('index', page=p) }}" style="padding:8px 10px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(2,6,23,0.04);text-decoration:none">{{ p }}</a>
                    {% elif pagination_endpoint == 'search' %}
                        <a href="{{ url_for('search', q=pagination_args['q'], page=p) }}" style="padding:8px 10px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(2,6,23,0.04);text-decoration:none">{{ p }}</a>
                    {% elif pagination_endpoint == 'posts_by_tag' %}
                        <a href="{{ url_for('posts_by_tag', tag=pagination_args['tag'], page=p) }}" style="padding:8px 10px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(2,6,23,0.04);text-decoration:none">{{ p }}</a>
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% if posts.has_next %}
                {% if pagination_endpoint == 'index' %}
                    <a href="{{ url_for('index', page=posts.next_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Next</a>
                {% elif pagination_endpoint == 'search' %}
                    <a href="{{ url_for('search', q=pagination_args['q'], page=posts.next_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Next</a>
                {% elif pagination_endpoint == 'posts_by_tag' %}
                    <a href="{{ url_for('posts_by_tag', tag=pagination_args['tag'], page=posts.next_num) }}" class="btn-primary" style="width:auto;padding:8px 10px">Next</a>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}