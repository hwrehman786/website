{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="recommendations-container">
        <div class="recommendations-header">
            <h1>Recommended Users</h1>
            <p>Discover new creators to follow</p>
        </div>

        {% if recommended_users %}
        <div class="recommendations-grid">
            {% for user in recommended_users %}
            <div class="recommend-card">
                <div class="recommend-avatar">
                    {% if user.avatar_filename %}
                    <img src="{{ url_for('static', filename='uploads/avatars/' + user.avatar_filename) }}"
                        alt="{{ user.username }}">
                    {% else %}
                    <div class="avatar-placeholder">{{ user.username[0].upper() }}</div>
                    {% endif %}
                </div>

                <a href="/profile/{{ user.username }}" class="recommend-username">{{ user.username }}</a>

                <div class="recommend-bio">{{ user.bio if user.bio else 'No bio' }}</div>

                <div class="recommend-stats">
                    <span class="stat">
                        <strong>{{ user.followers.count() }}</strong>
                        <em>followers</em>
                    </span>
                    <span class="stat">
                        <strong>{{ user.posts|length }}</strong>
                        <em>posts</em>
                    </span>
                </div>

                <div class="recommend-actions">
                    <button class="btn-follow" onclick="toggleFollow({{ user.id }}, this)">Follow</button>
                    <a href="/messages/{{ user.id }}" class="btn-follow"
                        style="text-decoration: none; display: flex; align-items: center; justify-content: center;"
                        title="Send a message">
                        <i class="fas fa-envelope"></i> Message
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ðŸŽ¯</div>
            <h2>No recommendations available</h2>
            <p>You're already following most users or there aren't enough users to recommend</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .recommendations-container {
        max-width: 1000px;
        margin: 2rem auto;
        background: #faf7f5;
        border-radius: 12px;
        padding: 2rem;
    }

    .recommendations-header {
        text-align: center;
        border-bottom: 2px solid #00d4ff;
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }

    .recommendations-header h1 {
        margin: 0 0 0.5rem 0;
        color: #222;
    }

    .recommendations-header p {
        margin: 0;
        color: #666;
    }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }

    .recommend-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border-left: 4px solid #ff6b35;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .recommend-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 212, 255, 0.15);
    }

    .recommend-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .recommend-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        font-size: 2.5rem;
        font-weight: 600;
        color: #00d4ff;
    }

    .recommend-username {
        font-weight: 600;
        color: #00d4ff;
        text-decoration: none;
        font-size: 1rem;
    }

    .recommend-username:hover {
        text-decoration: underline;
    }

    .recommend-bio {
        color: #666;
        font-size: 0.85rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.4em;
    }

    .recommend-stats {
        display: flex;
        gap: 1rem;
        justify-content: center;
        width: 100%;
        padding: 0.75rem 0;
        border-top: 1px solid #f0f0f0;
        border-bottom: 1px solid #f0f0f0;
    }

    .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .stat strong {
        color: #222;
        font-size: 0.95rem;
    }

    .stat em {
        color: #999;
        font-size: 0.75rem;
        font-style: normal;
    }

    .recommend-actions {
        display: flex;
        gap: 0.5rem;
        width: 100%;
    }

    .recommend-actions .btn-follow {
        flex: 1;
        padding: 0.75rem 1rem;
        background: #00d4ff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .recommend-actions .btn-follow:hover {
        background: #00b8d4;
        transform: scale(1.02);
    }

    .btn-follow {
        width: 100%;
        padding: 0.75rem 1rem;
        background: #00d4ff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-follow:hover {
        background: #00b8d4;
        transform: scale(1.02);
    }

    .btn-follow:active {
        transform: scale(0.98);
    }

    .btn-follow.following {
        background: #ff6b35;
    }

    .btn-follow.following:hover {
        background: #e55a24;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #666;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .empty-state h2 {
        color: #222;
        margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
        .recommendations-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .recommend-avatar {
            width: 80px;
            height: 80px;
        }
    }
</style>

<script>
    // Make function globally available to avoid scope issues
    window.toggleFollow = function (userId, button) {
        // Debug alert to verify click works
        // alert('Follow clicked: ' + userId);

        console.log('Attempting to follow user:', userId);

        const originalText = button.textContent;
        const isFollowing = button.classList.contains('following');

        // Immediate UI feedback
        button.disabled = true;
        button.textContent = isFollowing ? 'Unfollowing...' : 'Following...';

        fetch(`/api/follow/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(d => {
                console.log('Follow response:', d);
                if (d.success) {
                    if (d.followed) {
                        button.textContent = 'Following';
                        button.classList.add('following');
                    } else {
                        button.textContent = 'Follow';
                        button.classList.remove('following');
                    }
                } else {
                    console.error('Follow action failed:', d);
                    alert('Failed to update follow status: ' + (d.message || 'Unknown error'));
                    button.textContent = originalText;
                }
            })
            .catch(err => {
                console.error('Error toggling follow:', err);
                alert('An error occurred while following user');
                button.textContent = originalText;
            })
            .finally(() => {
                button.disabled = false;
            });
    }
</script>
{% endblock %}